# conga-packages

This role provides a generic, reusable way to install all AEM packages generated for a [CONGA](http://devops.wcm.io/conga/) role to a running AEM instance. It is meant to be included or declared as dependency by other roles that need to install packages generated by CONGA. But it can also used directly if a CONGA role only generates AEM packages. In this case all that is needed to deploy the CONGA role to AEM is apply this role with the appropriate `conga_role_mapping` (see [conga-facts](https://github.com/wcm-io-devops/ansible-conga-facts)).

## Requirements

This role requires Ansible 2.0 or higher. Maven must be installed since the role uses the [wcm.io Content Package Maven Plugin](http://wcm.io/tooling/maven/plugins/wcmio-content-package-maven-plugin/) for the actual package installation, 


## Role Variables

Available variables are listed below, along with their default values:

	conga_aem_packages_maven_cmd: mvn

Name of the Maven executable to use. 

	conga_aem_packages_wcmio_content_package_maven_plugin_version: 1.6.0

The version of the wcm.io content package maven plugin to use.

	conga_aem_packages_wcmio_content_package_maven_plugin_changed_output: "Package installed"

The string to looks for in the output of the package plugin to determine if a package was actually installed or skipped because it was already installed. This is important to avoid unnecessary lengthy restarts (e.g. when a service pack is part of package list).

	conga_aem_packages_port: "{{ conga_config.quickstart.port }}"

The port of the target AEM instance. It defaults to the port configured in the [`aem-cms`](https://github.com/wcm-io-devops/conga-aem-definitions/blob/develop/conga-aem-definitions/src/main/roles/aem-cms.yaml) role to make it automatically work for both author and publisher instances (provided that the package role inherits from this role so that it can access its configuration).

	conga_aem_packages_service_url: "http://{{ inventory_hostname }}:{{ conga_aem_packages_port }}/crx/packmgr/service"

The  package manager service URL the Maven plugin uses to poll the package state.

    conga_aem_bundle_status_url: "http://{{ inventory_hostname }}:{{ conga_aem_packages_port }}/system/console/bundles.json"

Bundle status URL to poll while waiting for installation is complete when package is using a installer bundle (like AEM 6.3 SP2).

    conga_aem_bundle_status_timeout: 600

Timeout to wait (10 minutes per default) for installer bundle to be removed.

    conga_aem_bundle_status_retry_delay: 10

The retry delay for calling the `conga_aem_bundle_status_url`.

Additionally, the role expects the `conga_packages` variable to be set by the [conga-facts](https://github.com/wcm-io-devops/ansible-conga-facts) role (on which this role depends) to the list of packages from the CONGA configuration model.

## Dependencies

This role depends on the
[conga-facts](https://github.com/wcm-io-devops/ansible-conga-facts) role
for supplying the list of packages to install. It also depends on a role
that provides a handler named "aem restart". This handler is normally
provided by the
[ansible-aem-service](https://github.com/wcm-io-devops/ansible-aem-service)
role, which is used by the conga ansible automation when using the
[ansible-conga-aem-cms](https://github.com/wcm-io-devops/ansible-conga-aem-cms) role.

## Example Playbook

This playbook sets the `conga_aem_packages_port`  variable from the CONGA configuration of the `aem-cms` role and then installs all packages generated by the role `my-application-role`.

	- hosts: aem
	  pre_tasks:
	    - conga_facts:
	        conga_role_mapping: aem-cms
	    - set_fact:
	        conga_aem_packages_port: "{{ conga_config.quickstart.port }}"
	
	  roles:
	    - { role: conga-aem-packages, conga_role_mapping: my-application-role}

## License

Apache 2.0
